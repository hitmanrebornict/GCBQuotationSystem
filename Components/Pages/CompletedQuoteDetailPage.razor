@attribute [Authorize(Roles = "Sales Admin,Sales User,IT Admin,Admin")]

@page "/QuoteDetailPage/{quoteID:int}"

@inject QuoteDetailServices QuoteDetailService
@inject QuoteDataServices QuoteDataService
@inject GenerateQuoteServices GenerateQuoteService
@inject IJSRuntime JS
@inject UserPreferenceSettings UserPreferenceSetting
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<PageTitle>Quote Details</PageTitle>

@using iText.Kernel.Pdf;
@using iText.Layout;
@using iText.Layout.Element;
@using System.IO.Compression;

@implements IDisposable

<div class="container-fluid mb-4">
    <div class="row mb-3">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <RadzenSelectBar @bind-Value=@SelectBarValue TValue="bool" class="w-100">
                <Items>
                    <RadzenSelectBarItem Text="Summary" Value="true" />
                    <RadzenSelectBarItem Text="Listing" Value="false" />
                </Items>
            </RadzenSelectBar>
        </div>
        <div class="col-12 col-md-6">
            @if (hasCurrencyChanged)
            {
                <div class="mb-2 mb-md-0">
                    <RadzenBadge Text="@($"Viewing in {UserPreferenceSetting.Currency}")" 
                                BadgeStyle="BadgeStyle.Info" />
                </div>
            }
            
            <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                @if (quote.StatusId != 3)
                {
                    <RadzenButton Text="Update" Icon="arrow_upward" ButtonType="ButtonType.Submit" 
                        Click="@(async() => await updateQuote(quote))" 
                        ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                }

                @if (quote.StatusId == 1)
                {
                    <RadzenButton Icon="upload_file" ButtonType="ButtonType.Submit" Text="Post" 
                        Click="@(async() => await postQuote(quote))" 
                        ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                }
                else if (quote.StatusId == 2)
                {
                    <RadzenButton Icon="check" ButtonType="ButtonType.Submit" Text="Complete" 
                        Click="@(async() => await completeQuote(quote))" 
                        ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                }

                @if (quote.StatusId != 4)
                {
                    <RadzenButton Icon="archive" ButtonType="ButtonType.Submit" Text="Archive" 
                        Click="@(async() => await archiveQuote(quote))" 
                        ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
                }

                <RadzenButton Text="Duplicate" ButtonType="ButtonType.Submit" 
                    Click="DuplicateQuotation" Icon="content_copy" 
                    ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small" />

                <RadzenButton Icon="file_download" Text="Excel" ButtonType="ButtonType.Submit" 
                    Click="ExportSummaryAndRedirect" 
                    ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" />
                <RadzenButton Icon="file_download" Text="PDF" ButtonType="ButtonType.Submit" 
                    Click="ExportSummaryToPDF" 
                    ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" />
            </div>
        </div>
    </div>

    <RadzenCard class="shadow-sm mb-4">
        @if (load)
        {
            <div class="row">
                <div class="col-12">
                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mb-3">
                        <h4 class="me-md-3 mb-2 mb-md-0">Quotation ID: @quote.QuoteId</h4>
                        @if (status == "Created")
                        {
                            <RadzenBadge Text="Created" BadgeStyle="BadgeStyle.Warning" />
                        }
                        else if (status == "Confirmed")
                        {
                            <RadzenBadge Text="Confirmed" BadgeStyle="BadgeStyle.Info" />
                        }
                        else if (status == "Completed")
                        {
                            <RadzenBadge Text="Completed" BadgeStyle="BadgeStyle.Success" />
                        }
                    </div>

                    <div class="row">
                        <div class="col-12 col-sm-6 col-md-4">
                            <p class="mb-1"><strong>Quote Date:</strong></p>
                            <p class="mb-2">@quote.CreatedAt?.ToString("dd MMM yyyy hh:mm tt")</p>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4">
                            <p class="mb-1"><strong>Customer Name:</strong></p>
                            <p class="mb-2">@quote.Customer.CustName</p>
                        </div>
                        <div class="col-12 col-md-4">
                            <p class="mb-1"><strong>Delivery Address:</strong></p>
                            <p class="mb-2">@GetDeliveryAddress()</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </RadzenCard>

    @if(SelectBarValue)
    {
        @if(isDataLoaded)
        {
            <QuoteDetailPage 
                isInCompletedQuotePage="true"
                QuoteRemark="@QuoteRemark"
                CustomerRemark="@CustomerRemark" />
        }
        else
        {
            <div class="text-center p-5">
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" 
                    Style="width: 50%; margin: 0 auto;" />
                <p class="mt-3">Loading quote details...</p>
            </div>
        }
    }
    else
    {
        @if(isDataLoaded)
        {
            <RadzenCard class="shadow-sm mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <RadzenText Text="Cost Conclusion Summary" TextStyle="TextStyle.DisplayH5" class="mb-0"></RadzenText>
                    <RadzenText Text="@($"Average costs across all periods ({GetRecipeCount()} recipes)")" TextStyle="TextStyle.Subtitle2" class="text-muted"></RadzenText>
                </div>
                
                <div class="row">
                    @foreach (var recipeSummary in GetRecipeCostSummaries())
                    {
                        <div class="col-12 col-sm-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0 text-truncate">
                                        <i class="rz-icon-receipt me-2"></i>
                                        @recipeSummary.RecipeCode
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <!-- Raw Material Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_rawmaterial"))">
                                                <span class="text-muted small">Raw Material Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-primary me-2 small">@recipeSummary.AverageRawMaterialCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_rawmaterial") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_rawmaterial"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    @foreach (var material in recipeSummary.RawMaterialBreakdown)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center py-1">
                                                            <small class="text-muted">@material.Key:</small>
                                                            <small class="fw-medium">@material.Value.ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>



                                        <!-- Premium Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_premium"))">
                                                <span class="text-muted small">Premium Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-warning me-2 small">@recipeSummary.AveragePremiumCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_premium") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_premium"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    @foreach (var premium in recipeSummary.PremiumCostBreakdown)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center py-1">
                                                            <small class="text-muted">@premium.Key:</small>
                                                            <small class="fw-medium">@premium.Value.ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>

                                        <!-- Packaging Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_packaging"))">
                                                <span class="text-muted small">Packaging Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-secondary me-2 small">@recipeSummary.AveragePackagingCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_packaging") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_packaging"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    <small class="text-muted">@recipeSummary.PackagingDetails</small>
                                                </div>
                                            }
                                        </div>

                                        <!-- Delivery Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_delivery"))">
                                                <span class="text-muted small">Delivery Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-dark me-2 small">@recipeSummary.AverageDeliveryCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_delivery") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_delivery"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    <small class="text-muted">@recipeSummary.DeliveryDetails</small>
                                                </div>
                                            }
                                        </div>

                                        <!-- Production Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_production"))">
                                                <span class="text-muted small">Production Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-success me-2 small">@recipeSummary.AverageProductionCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_production") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_production"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    <small class="text-muted">@recipeSummary.ProductionDetails</small>
                                                </div>
                                            }
                                        </div>

                                        <!-- Additional Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_additional"))">
                                                <span class="text-muted small">Additional Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-danger me-2 small">@recipeSummary.AverageAdditionalCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_additional") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_additional"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    @foreach (var additional in recipeSummary.AdditionalCostBreakdown)
                                                    {
                                                        <div class="d-flex justify-content-between align-items-center py-1">
                                                            <small class="text-muted">@additional.Key:</small>
                                                            <small class="fw-medium">@additional.Value.ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>

                                        <!-- Financial Cost -->
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="@(() => ToggleExpanded($"{recipeSummary.RecipeCode}_financial"))">
                                                <span class="text-muted small">Financial Cost:</span>
                                                <div class="d-flex align-items-center">
                                                    <strong class="text-primary me-2 small">@recipeSummary.AverageFinancialCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                                    <i class="rz-icon @(IsExpanded($"{recipeSummary.RecipeCode}_financial") ? "chevron-up" : "chevron-down") small"></i>
                                                </div>
                                            </div>
                                            @if (IsExpanded($"{recipeSummary.RecipeCode}_financial"))
                                            {
                                                <div class="ms-2 ms-md-3 mt-2" style="background-color: #f8f9fa; padding: 8px; border-radius: 5px;">
                                                    <small class="text-muted">@recipeSummary.FinancialDetails</small>
                                                </div>
                                            }
                                        </div>

                                        <hr class="my-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted fw-bold">Total Average Cost:</span>
                                            <strong class="text-primary fs-5">@recipeSummary.AverageCost.ToString("C0", UserPreferenceSetting.CultureInfo)</strong>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span class="text-muted">Periods:</span>
                                            <span class="badge bg-secondary">@recipeSummary.PeriodCount periods</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
        </div>
                    }
                </div>
                
                @if (GetRecipeCostSummaries().Any())
                {
                    <hr class="my-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="card bg-light border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary mb-3">
                                        <i class="rz-icon-calculate me-2"></i>
                                        Overall Summary
                                    </h5>
                                    <div class="row mb-3">
                                        <div class="col-6 col-md-3 mb-3 mb-md-0">
                                            <div class="text-center">
                                                <h5 class="text-primary mb-1">@GetTotalAverageCost().ToString("C0", UserPreferenceSetting.CultureInfo)</h5>
                                                <small class="text-muted">Total Average Cost</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3 mb-md-0">
                                            <div class="text-center">
                                                <h5 class="text-success mb-1">@GetOverallMinCost().ToString("C0", UserPreferenceSetting.CultureInfo)</h5>
                                                <small class="text-muted">Lowest Cost</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3 mb-md-0">
                                            <div class="text-center">
                                                <h5 class="text-danger mb-1">@GetOverallMaxCost().ToString("C0", UserPreferenceSetting.CultureInfo)</h5>
                                                <small class="text-muted">Highest Cost</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-info mb-1">@GetTotalPeriods()</h5>
                                                <small class="text-muted">Total Periods</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-3">
                                    <h6 class="text-muted mb-3">Average Cost Breakdown by Component:</h6>
                                    <div class="row">
                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Raw Material:</small>
                                                <small class="fw-medium text-primary">@GetTotalAverageRawMaterialCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>

                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Premium:</small>
                                                <small class="fw-medium text-warning">@GetTotalAveragePremiumCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Packaging:</small>
                                                <small class="fw-medium text-secondary">@GetTotalAveragePackagingCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Delivery:</small>
                                                <small class="fw-medium text-dark">@GetTotalAverageDeliveryCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Production:</small>
                                                <small class="fw-medium text-success">@GetTotalAverageProductionCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Additional:</small>
                                                <small class="fw-medium text-danger">@GetTotalAverageAdditionalCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-3 mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Financial:</small>
                                                <small class="fw-medium text-primary">@GetTotalAverageFinancialCost().ToString("C0", UserPreferenceSetting.CultureInfo)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </RadzenCard>
        }
        else
        {
            <div class="text-center p-5">
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" 
                    Style="width: 50%; margin: 0 auto;" />
                <p class="mt-3">Loading cost summary...</p>
            </div>
        }
    }
</div>

@code {

    [Parameter]
    public int quoteID { get; set; }

    // Add these fields to track currency changes
    private string originalUserCurrency;
    private bool hasCurrencyChanged = false;

    private Quote quote = new Quote();
    private Dictionary<string, decimal> terminalCosts = new();
    private List<QuotationRawMaterialCost> rawMaterialCosts = new();
    private bool load = false;
    private List<RecipeCostMatrix> quarterViewCost = new List<RecipeCostMatrix>();

    bool SelectBarValue = true;

    private string QuoteRemark, CustomerRemark;

    private List<CostSummaryRow> costMatrix;
    private List<string> periodColumns = new();
    private string status;

    private bool isDataLoaded = false;
    private string custName;
    
    // State management for expandable sections
    private Dictionary<string, bool> expandedSections = new Dictionary<string, bool>();

    protected override async Task OnInitializedAsync()
    {
        // Store the original user currency preference
        originalUserCurrency = UserPreferenceSetting.Currency;

        quote = await QuoteDetailService.GetQuoteAsync(quoteID);

        if(quote != null){
            custName = quote.Customer.CustName;
            status = quote.Status.StatusName;
            QuoteRemark = quote.Remark;
            CustomerRemark = quote.CustomerRemark;

            // Switch to quote's currency if different from user preference
            if (!string.IsNullOrEmpty(quote.Currency?.CurrencyCode) && 
                quote.Currency.CurrencyCode != UserPreferenceSetting.Currency)
            {
                UserPreferenceSetting.Currency = quote.Currency.CurrencyCode;
                UserPreferenceSetting.UpdateCultureBasedOnCurrency();
                hasCurrencyChanged = true;
            }
        }

        load = true;

        // Assuming quote has a list of recipes and their costs
        List<RecipeTotalCost> recipeTotalCostList = new List<RecipeTotalCost>();

        // Transform the quote into RecipeTotalList
        foreach (var quotationRecipe in quote.QuotationRecipes)
        {
            // Calculate the total cost for the recipe
            var localTotalCost = QuoteDataService.CalculateTotalCost(quotationRecipe);

            // Create a new RecipeTotalCost object for this recipe
            var recipeTotalCost = new RecipeTotalCost
                {
                    QuotationRecipe1 = quotationRecipe,
                    TotalCost = localTotalCost,
                    Quarter = GenerateQuoteService.GetQuarter(quotationRecipe.PeriodMonth) // Assuming you need this format for Quarter
                };
            // Add the recipe total cost to the list
            recipeTotalCostList.Add(recipeTotalCost);
        }

        QuoteDataService.ClearAllRecipeData();

        QuoteDataService.RecipeTotalCostList = QuoteDataService.ConvertRecipeCostListToPreferredUnit(recipeTotalCostList, UserPreferenceSetting.WeightRatio);

        QuoteDataService.OriginalRecipeTotalList = recipeTotalCostList; 
        QuoteDataService.RecipeCostMatrix = await QuoteDataService.PrepareCostMatrix(QuoteDataService.RecipeTotalCostList);
        quarterViewCost = await QuoteDataService.PrepareQuarterCostMatrix(recipeTotalCostList);

        if(QuoteDataService.RecipeTotalCostList != null && QuoteDataService.RecipeCostMatrix != null){
            isDataLoaded = true;
        }

        await InvokeAsync(StateHasChanged);
    }

    // Implement IDisposable to restore currency when leaving the page
    public void Dispose()
    {
        // Restore original currency when leaving the page
        if (hasCurrencyChanged && !string.IsNullOrEmpty(originalUserCurrency))
        {
            UserPreferenceSetting.Currency = originalUserCurrency;
            UserPreferenceSetting.UpdateCultureBasedOnCurrency();
        }
    }

    public class CostSummaryRow
    {
        public string RecipeCode { get; set; }
        public string CostType { get; set; }
        public Dictionary<string, decimal> PeriodCosts { get; set; } = new();
        public decimal TotalCost => PeriodCosts.Values.Sum();  // Calculate the sum of all period costs
    }

    public class RecipeCostSummary
    {
        public string RecipeCode { get; set; }
        public decimal AverageCost { get; set; }
        public decimal MinCost { get; set; }
        public decimal MaxCost { get; set; }
        public int PeriodCount { get; set; }
        public Dictionary<string, decimal> PeriodCosts { get; set; } = new();
        
        // Detailed cost breakdowns
        public decimal AverageRawMaterialCost { get; set; }
        public decimal AveragePremiumCost { get; set; }
        public decimal AveragePackagingCost { get; set; }
        public decimal AverageDeliveryCost { get; set; }
        public decimal AverageProductionCost { get; set; }
        public decimal AverageAdditionalCost { get; set; }
        public decimal AverageFinancialCost { get; set; }
        
        // Detailed breakdowns for expandable sections
        public Dictionary<string, decimal> RawMaterialBreakdown { get; set; } = new();
        public Dictionary<string, decimal> AdditionalCostBreakdown { get; set; } = new();
        public Dictionary<string, decimal> PremiumCostBreakdown { get; set; } = new();
        public string PackagingDetails { get; set; } = "";
        public string DeliveryDetails { get; set; } = "";
        public string ProductionDetails { get; set; } = "";
        public string FinancialDetails { get; set; } = "";
    }

    private List<RecipeCostSummary> GetRecipeCostSummaries()
    {
        if (QuoteDataService?.RecipeTotalCostList == null || !QuoteDataService.RecipeTotalCostList.Any())
            return new List<RecipeCostSummary>();

        // Group by recipe code to calculate averages for each cost component
        var groupedByRecipe = QuoteDataService.RecipeTotalCostList
            .GroupBy(r => r.QuotationRecipe1.Recipe.RecipeCode)
            .ToList();

        return groupedByRecipe.Select(recipeGroup => 
        {
            var recipes = recipeGroup.ToList();
            var recipeCode = recipeGroup.Key;
            
            // Calculate detailed breakdowns
            var rawMaterialBreakdown = new Dictionary<string, decimal>();
            var additionalCostBreakdown = new Dictionary<string, decimal>();
            var premiumCostBreakdown = new Dictionary<string, decimal>();
            
            // Aggregate raw material costs by material name
            foreach (var recipe in recipes)
            {
                if (recipe.QuotationRecipe1.QuotationRawMaterialCosts != null)
                {
                    foreach (var rm in recipe.QuotationRecipe1.QuotationRawMaterialCosts)
                    {
                        if (rawMaterialBreakdown.ContainsKey(rm.MaterialName))
                            rawMaterialBreakdown[rm.MaterialName] += rm.CostAmount;
                        else
                            rawMaterialBreakdown[rm.MaterialName] = rm.CostAmount;
                    }
                }
            }
            
            // Average the raw material costs
            foreach (var key in rawMaterialBreakdown.Keys.ToList())
            {
                rawMaterialBreakdown[key] = rawMaterialBreakdown[key] / recipes.Count;
            }
            
            // Aggregate additional costs by cost name
            foreach (var recipe in recipes)
            {
                if (recipe.QuotationRecipe1.QuotationAdditionalCosts != null)
                {
                    foreach (var ac in recipe.QuotationRecipe1.QuotationAdditionalCosts)
                    {
                        if (additionalCostBreakdown.ContainsKey(ac.CostName))
                            additionalCostBreakdown[ac.CostName] += ac.CostAmount;
                        else
                            additionalCostBreakdown[ac.CostName] = ac.CostAmount;
                    }
                }
            }
            
            // Average the additional costs
            foreach (var key in additionalCostBreakdown.Keys.ToList())
            {
                additionalCostBreakdown[key] = additionalCostBreakdown[key] / recipes.Count;
            }
            
            // Aggregate premium costs by premium name
            foreach (var recipe in recipes)
            {
                if (recipe.QuotationRecipe1.QuotationPremiumCosts != null)
                {
                    foreach (var pc in recipe.QuotationRecipe1.QuotationPremiumCosts)
                    {
                        if (premiumCostBreakdown.ContainsKey(pc.PremiumName))
                            premiumCostBreakdown[pc.PremiumName] += pc.CostAmount;
                        else
                            premiumCostBreakdown[pc.PremiumName] = pc.CostAmount;
                    }
                }
            }
            
            // Average the premium costs
            foreach (var key in premiumCostBreakdown.Keys.ToList())
            {
                premiumCostBreakdown[key] = premiumCostBreakdown[key] / recipes.Count;
            }
            
            // Get sample details for single-value costs
            var sampleRecipe = recipes.First();
            var packagingDetails = sampleRecipe.QuotationRecipe1.QuotationPackagingCost != null ? 
                $"{sampleRecipe.QuotationRecipe1.QuotationPackagingCost.PackagingName}: {sampleRecipe.QuotationRecipe1.QuotationPackagingCost.Cost:C0}" : "N/A";
            
            var deliveryDetails = sampleRecipe.QuotationRecipe1.QuotationDeliveryCost != null ? 
                $"{sampleRecipe.QuotationRecipe1.QuotationDeliveryCost.DeliveryName}" : "N/A";
            
            var productionDetails = sampleRecipe.QuotationRecipe1.QuotationProductionCost != null ? 
                $"{sampleRecipe.QuotationRecipe1.QuotationProductionCost.ProductType}: {sampleRecipe.QuotationRecipe1.QuotationProductionCost.ProductTypeCost:C0}" : "N/A";
            
            var financialDetails = sampleRecipe.QuotationRecipe1.QuotationFinancialCost != null ? 
                $"Interest Rate: {sampleRecipe.QuotationRecipe1.QuotationFinancialCost.InterestRate}%, Finance Days: {sampleRecipe.QuotationRecipe1.QuotationFinancialCost.FinanceDays}" : "N/A";
            
            return new RecipeCostSummary
            {
                RecipeCode = recipeCode,
                PeriodCosts = recipes.ToDictionary(
                    r => r.QuotationRecipe1.PeriodMonth.ToString("MMMM yyyy"), 
                    r => r.TotalCost
                ),
                AverageCost = recipes.Average(r => r.TotalCost),
                MinCost = recipes.Min(r => r.TotalCost),
                MaxCost = recipes.Max(r => r.TotalCost),
                PeriodCount = recipes.Count,
                
                // Calculate average for each cost component
                AverageRawMaterialCost = recipes.Average(r => r.QuotationRecipe1.QuotationRawMaterialCosts?.Sum(rm => rm.CostAmount) ?? 0),
                AveragePremiumCost = recipes.Average(r => r.QuotationRecipe1.QuotationPremiumCosts?.Sum(p => p.CostAmount) ?? 0),
                AveragePackagingCost = recipes.Average(r => r.QuotationRecipe1.QuotationPackagingCost?.CostAmount ?? 0),
                AverageDeliveryCost = recipes.Average(r => r.QuotationRecipe1.QuotationDeliveryCost?.CostAmount ?? 0),
                AverageProductionCost = recipes.Average(r => r.QuotationRecipe1.QuotationProductionCost?.ProductTypeCost ?? 0),
                AverageAdditionalCost = recipes.Average(r => r.QuotationRecipe1.QuotationAdditionalCosts?.Sum(a => a.CostAmount) ?? 0),
                AverageFinancialCost = recipes.Average(r => r.QuotationRecipe1.QuotationFinancialCost != null ? 
                    (r.QuotationRecipe1.QuotationFinancialCost.InterestRate / 100 * r.TotalCost * r.QuotationRecipe1.QuotationFinancialCost.FinanceDays / 365) : 0),
                
                // Detailed breakdowns
                RawMaterialBreakdown = rawMaterialBreakdown,
                AdditionalCostBreakdown = additionalCostBreakdown,
                PremiumCostBreakdown = premiumCostBreakdown,
                PackagingDetails = packagingDetails,
                DeliveryDetails = deliveryDetails,
                ProductionDetails = productionDetails,
                FinancialDetails = financialDetails
            };
        }).ToList();
    }

    private int GetRecipeCount()
    {
        return QuoteDataService?.RecipeCostMatrix?.Count ?? 0;
    }

    private decimal GetTotalAverageCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AverageCost);
    }

    private decimal GetOverallMinCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Min(s => s.MinCost);
    }

    private decimal GetOverallMaxCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Max(s => s.MaxCost);
    }

    private int GetTotalPeriods()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Sum(s => s.PeriodCount);
    }

    private decimal GetTotalAverageRawMaterialCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AverageRawMaterialCost);
    }



    private decimal GetTotalAveragePremiumCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AveragePremiumCost);
    }

    private decimal GetTotalAveragePackagingCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AveragePackagingCost);
    }

    private decimal GetTotalAverageDeliveryCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AverageDeliveryCost);
    }

    private decimal GetTotalAverageProductionCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AverageProductionCost);
    }

    private decimal GetTotalAverageAdditionalCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AverageAdditionalCost);
    }

    private decimal GetTotalAverageFinancialCost()
    {
        var summaries = GetRecipeCostSummaries();
        if (!summaries.Any()) return 0;
        
        return summaries.Average(s => s.AverageFinancialCost);
    }

    private void ToggleExpanded(string key)
    {
        if (expandedSections.ContainsKey(key))
            expandedSections[key] = !expandedSections[key];
        else
            expandedSections[key] = true;
        
        StateHasChanged();
    }

    private bool IsExpanded(string key)
    {
        return expandedSections.ContainsKey(key) && expandedSections[key];
    }

    private async Task ExportSummaryAndRedirect()
    {
        string folderPath = Path.Combine(Environment.CurrentDirectory, "wwwroot", "securefiles");
        Directory.CreateDirectory(folderPath);

        string fileName = $"QuoteSummary_{quoteID}_{DateTime.Now:yyyyMMddHHmmss}.xlsx";
        string fullPath = Path.Combine(folderPath, fileName);

        using var workbook = new ClosedXML.Excel.XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Summary");

        worksheet.Cell(1, 1).Value = "Recipe Code";

        var periods = QuoteDataService.RecipeCostMatrix
            .SelectMany(r => r.PeriodCosts.Keys)
            .Distinct()
            .OrderBy(p => DateTime.TryParse(p, out var dt) ? dt : DateTime.MaxValue)
            .ToList();

        for (int i = 0; i < periods.Count; i++)
            worksheet.Cell(1, i + 2).Value = periods[i];

        for (int i = 0; i < QuoteDataService.RecipeCostMatrix.Count; i++)
        {
            var recipe = QuoteDataService.RecipeCostMatrix[i];
            worksheet.Cell(i + 2, 1).Value = recipe.RecipeCode;

            for (int j = 0; j < periods.Count; j++)
            {
                if (recipe.PeriodCosts.TryGetValue(periods[j], out var value))
                    worksheet.Cell(i + 2, j + 2).Value = value;
            }
        }

        workbook.SaveAs(fullPath);

        // Open the download link in a new tab, requires user to be authorized
        var downloadUrl = $"api/SecureFiles/{fileName}";
        await JS.InvokeVoidAsync("open", downloadUrl, "_blank");
    }

    private async Task DuplicateQuotation(){

        QuoteDataService.newQuotation = new Quote
            {
                CustomerId = quote.CustomerId,
                DeliveryDetailId = quote.DeliveryDetailId,
                CreatedAt = DateTime.Now
            };

        NavigationManager.NavigateTo("/DuplicateNewQuote");
    }

    private async Task ExportSummaryToPDF()
    {
        string templatePath = Path.Combine(Environment.CurrentDirectory, "wwwroot", "Template", "GCBCUK_Letterhead.pdf");
        string folderPath = Path.Combine(Environment.CurrentDirectory, "wwwroot", "securefiles");
        Directory.CreateDirectory(folderPath);

        List<string> generatedFiles = new List<string>();

        // Determine which data to use based on the current view
        var dataToExport = SelectBarValue ? 
            QuoteDataService.RecipeCostMatrix : // Summary view (MONTH)
            quarterViewCost;                    // Listing view (QUARTER)

        var i = 1;
        foreach (var recipe in dataToExport)
        {
            string fileName = $"Quote_{quote.QuoteId}_{i}_{DateTime.Now:yyyyMMdd}.pdf";
            string fullPath = Path.Combine(folderPath, fileName);

            using (var pdfReader = new PdfReader(templatePath))
            using (var pdfWriter = new PdfWriter(fullPath))
            using (var pdfDoc = new PdfDocument(pdfReader, pdfWriter))
            using (var document = new Document(pdfDoc))
            {
                // Adjust starting Y position depending on your letterhead layout
                float startY = 700f;

                // Format date without time
                string formattedDate = quote.CreatedAt?.ToString("dd MMM yyyy") ?? "-";

                // Add formal introduction with customer name
                document.ShowTextAligned($"Date: {formattedDate}", 30, startY, iText.Layout.Properties.TextAlignment.LEFT);

                // Add formal greeting with customer name
                document.ShowTextAligned($"Dear {quote.Customer.CustName},", 30, startY - 30, iText.Layout.Properties.TextAlignment.LEFT);
                document.ShowTextAligned("We are pleased to quote you:", 30, startY - 50, iText.Layout.Properties.TextAlignment.LEFT);

                document.ShowTextAligned($"Recipe Code: {recipe.RecipeCode}", 30, startY - 80, iText.Layout.Properties.TextAlignment.LEFT);

                // Create table with 2 columns (removed quantity column)
                var table = new Table(2, true)
                    .SetMarginTop(190) // Adjusted margin since we removed the weight unit line
                    .SetMarginBottom(10)
                    .SetMarginRight(10)
                    .SetMarginLeft(-5);

                // Get the weight unit from user preferences
                string weightUnit = UserPreferenceSetting.PrintedWeightUnit ?? (UserPreferenceSetting.WeightRatio == 1 ? "KG" : "MT");

                // Set up table headers based on view type
                if (SelectBarValue) // MONTH view
                {
                    table.AddHeaderCell("Time Period");
                    table.AddHeaderCell($"Total Price ({weightUnit})");
                }
                else // QUARTER view
                {
                    table.AddHeaderCell("Quarter");
                    table.AddHeaderCell($"Total Price ({weightUnit})");
                }

                table.GetHeader().SetBold();

                // Add data rows based on view type
                if (SelectBarValue) // MONTH view
                {
                    foreach (var period in recipe.PeriodCosts.Keys.OrderBy(p => DateTime.TryParse(p, out var dt) ? dt : DateTime.MaxValue))
                    {
                        table.AddCell(new Cell().Add(new Paragraph(period).SetFontSize(8)));
                        table.AddCell(new Cell().Add(new Paragraph(Math.Ceiling(recipe.PeriodCosts[period]).ToString("C0")).SetFontSize(8)));
                    }
                }
                else // QUARTER view
                {
                    // For quarter view, we need to access the data differently
                    var quarterRecipe = recipe as RecipeCostMatrix;
                    if (quarterRecipe != null)
                    {
                        foreach (var quarter in quarterRecipe.PeriodCosts.Keys.OrderBy(q => q))
                        {
                            table.AddCell(new Cell().Add(new Paragraph(quarter).SetFontSize(8)));
                            table.AddCell(new Cell().Add(new Paragraph(quarterRecipe.PeriodCosts[quarter].ToString("C0")).SetFontSize(8)));
                        }
                    }
                }

                document.Add(table);

                // Add remarks if available
                if (!string.IsNullOrEmpty(QuoteRemark) || !string.IsNullOrEmpty(CustomerRemark))
                {



                    // Add customer remarks if available
                    if (!string.IsNullOrEmpty(CustomerRemark))
                    {

                        document.Add(new Paragraph("Customer Notes:").SetBold());
                        document.Add(new Paragraph(CustomerRemark)
                            .SetTextAlignment(iText.Layout.Properties.TextAlignment.LEFT));
                    }
                }

                // Add closing text with consistent left alignment
                document.Add(new Paragraph(" "));
                document.Add(new Paragraph("Thank you for your business. We look forward to serving you.")
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.LEFT));
                document.Add(new Paragraph(" "));
                document.Add(new Paragraph("Best regards,")
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.LEFT));
                document.Add(new Paragraph("GCB Cocoa UK Ltd")
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.LEFT));

                generatedFiles.Add(fullPath);
            }

            i++;
        }

        string zipFilePath = Path.Combine(folderPath, $"Quotes_{DateTime.Now:yyyyMMddHHmmss}.zip");
        using (var zip = ZipFile.Open(zipFilePath, ZipArchiveMode.Create))
        {
            foreach (var file in generatedFiles)
            {
                zip.CreateEntryFromFile(file, Path.GetFileName(file));
            }
        }

        // Provide download link to the zip file
        var downloadUrl = $"api/SecureFiles/{Path.GetFileName(zipFilePath)}";
        await JS.InvokeVoidAsync("open", downloadUrl, "_blank");
    }

    private async Task postQuote(Quote selectedQuote){
        await QuoteDetailService.PostQuote(selectedQuote);
        await OnInitializedAsync();

        await InvokeAsync(StateHasChanged);

        NotificationService.Notify(NotificationSeverity.Success, "Quotation is updated successfully.");
    }

    private async Task completeQuote(Quote selectedQuote)
    {
        await QuoteDetailService.CompleteQuote(selectedQuote);
        await OnInitializedAsync();

        await InvokeAsync(StateHasChanged);

        NotificationService.Notify(NotificationSeverity.Success, "Quotation is updated successfully.");
    }

    private async Task archiveQuote(Quote selectedQuote)
    {
        await QuoteDetailService.ArchiveQuote(selectedQuote);
        await OnInitializedAsync();

        await InvokeAsync(StateHasChanged);

        NotificationService.Notify(NotificationSeverity.Success, "Quotation archived successfully.");
    }

    private async Task updateQuote(Quote selectedQuote)
    {
        QuoteDataService.OriginalRecipeTotalList = QuoteDataService.RevertToOriginalUnit(QuoteDataService.RecipeTotalCostList, UserPreferenceSetting.WeightRatio);

        QuoteDataService.ClearAllRecipeData();

        await QuoteDetailService.updateQuoteInDatabase(selectedQuote, QuoteDataService.OriginalRecipeTotalList.Select(r => r.QuotationRecipe1).ToList());

        await OnInitializedAsync();

        await InvokeAsync(StateHasChanged);

        NotificationService.Notify(NotificationSeverity.Success, "Quotation is updated successfully.");
    }

    private string GetDeliveryAddress()
    {
        if (quote?.DeliveryDetailId != null && quote.Customer?.CustomerDeliveryDetails != null)
        {

            var deliveryDetail = quote.Customer.CustomerDeliveryDetails.First();

            
            if (deliveryDetail != null)
            {
                // Combine address components, filtering out null/empty values
                var addressParts = new List<string>();
                
                if (!string.IsNullOrWhiteSpace(deliveryDetail.Address1))
                    addressParts.Add(deliveryDetail.Address1);
                
                if (!string.IsNullOrWhiteSpace(deliveryDetail.Address2))
                    addressParts.Add(deliveryDetail.Address2);
                
                if (!string.IsNullOrWhiteSpace(deliveryDetail.City))
                    addressParts.Add(deliveryDetail.City);
                
                if (!string.IsNullOrWhiteSpace(deliveryDetail.Postcode))
                    addressParts.Add(deliveryDetail.Postcode);
                
           
                return addressParts.Count > 0 ? string.Join(", ", addressParts) : "No delivery address specified";
            }
        }
        
        return "No delivery address specified";
    }
}
